<div class="container-fluid">
    <!-- <div class="row">
        <div class="col-sm-6">
            <div class="card">
                <div class="card-header">
                    <h5>Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-warning" *ngIf="!editStatus" (click)="editStatus=!editStatus">Edit order</button>
                    <button class="btn btn-warning" *ngIf="editStatus" (click)="editStatus=!editStatus">Cancel edit</button>
                </div>
            </div>
        </div>
    </div> -->
    <div class="row" *ngFor="let o of fullOrderDetails; trackBy: trackByIndex">   
            
        <div class="col-sm-6" *ngIf="kycDetails">
            <div class="card" [routerLink]="['../../../users/kyc-list', kycDetails.id]"  [ngClass]="{'bg-dark': NoKYC,'bg-danger': kycDetails?.kyc_status=='Query raised','bg-success': kycDetails?.kyc_status=='eKYC approved', 'bg-warning': kycDetails?.kyc_status=='eKYC submitted'}" >
                <div class="card-body">
                    <h2 class="text-white" *ngIf="!NoKYC">{{kycDetails?.kyc_status}}</h2>
                    <h2 class="text-white" *ngIf="NoKYC">Awaiting eKYC</h2>
                </div>
            </div>
        </div>
        <div class="col-sm-6" *ngIf="!kycDetails">
            <div class="card bg-dark" >
                <div class="card-body">
                    <h2 class="text-white" *ngIf="NoKYC">Awaiting eKYC</h2>
                </div>
            </div>
        </div>

        <div class="col-sm-6"></div>

        <div class="col-sm-6">
            <div class="card">
                <div class="card-header">
                    <h5>Customer details</h5>
                </div>
                <div class="card-body">
                    <p>Customer #: {{customerDetails[0].customer_id}} </p>
                    <p [routerLink]="['../../../users/customers',customerDetails[0].customer_id]">Name: {{customerDetails[0].firstName}} {{customerDetails[0].lastName}}</p>
                    <p>Email: {{customerDetails[0].email}}</p>
                    <p>Mobile: {{customerDetails[0].mobile}}</p>
                </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="card">
                <div class="card-header">
                    <h5>Invoice</h5>
                </div>
                <div class="card-body">
                    <p>Invoice # : {{fullOrderDetails[0].invoice_id}}</p>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Email id">
                        <div class="input-group-append">
                          <button class="btn btn-warning" type="button">Send</button>
                        </div>
                    </div>
                    <button class="btn btn-warning" (click)="downloadAsPDF()">Download Invoice</button>
                </div>
            </div>
        </div>
        
        <div class="col-sm-6">
            <div class="card">
                <div class="card-header">
                    <h5>Billing address</h5>
                </div>
                <div class="card-body">
                    <p>Name: <span>{{o.firstName}}</span></p>
                    <p>Address: <span>{{o.billingAddress[0].address_line1}},{{o.billingAddress[0].address_line2}},{{o.billingAddress[0].city}}-{{o.billingAddress[0].pincode}}.</span></p>
                    <p>Mobile: <span>{{o.mobile}}</span></p>
                    <p>Email: <span>{{o.email}}</span></p>
                </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="card">
                <div class="card-header">
                    <h5>Shipping address</h5>
                </div>
                <div class="card-body">
                    <p>Name: <span>{{o.firstName}}</span></p>
                    <p>Address: <span>{{o.shippingAddress[0].address_line1}},{{o.shippingAddress[0].address_line2}},{{o.shippingAddress[0].city}}-{{o.shippingAddress[0].pincode}}.</span></p>
                    <p>Mobile: <span>{{o.mobile}}</span></p>
                    <p>Email: <span>{{o.email}}</span></p>
                </div>
            </div>
        </div>

        <div class="col-sm-3">
            <div class="card">
                <div class="card-header">
                    <h5>Order details</h5>
                </div>
                <div class="card-body">
                    <p>Order date: {{o.createdAt | date:'dd MM yyyy HH:mm'}}</p>
                    <p>Order #: {{o.order_id}}</p>
                    <p>Invoice #: {{fullOrderDetails[0].invoice_id}}</p>
                    <p *ngIf="!orderStatusActive">Order status: {{o.orderStatusName}} <i class="fa fa-pencil" *ngIf="editStatus" (click)="orderStatusActive=!orderStatusActive"></i></p>
                    <div class="card" *ngIf="orderStatusActive">
                        <div class="card-header">
                            <p>Order status <span class="pull-right" (click)="orderStatusActive=!orderStatusActive">X</span></p>
                        </div>
                        <div class="card-body">
                                <select class="form-control" [(ngModel)]="orderField">
                                    <option *ngFor="let ps of orderStatuses" value="{{ps.id}}">{{ps.order_status}}</option>
                                </select>
                                <br>
                                <button class="btn btn-warning" (click)="updateOrderField(o.order_id,'orderStatus',orderField)">Update</button>                                                   
                        </div>
                    </div>
                    <p *ngIf="!deliveryStatusActive">Delivery status: {{o.delivery_status}} <i class="fa fa-pencil" *ngIf="editStatus" (click)="deliveryStatusActive=!deliveryStatusActive"></i></p>
                    <div class="card" *ngIf="deliveryStatusActive">
                        <div class="card-header">
                            <p>Delivery status <span class="pull-right" (click)="deliveryStatusActive=!deliveryStatusActive">X</span></p>
                        </div>
                        <div class="card-body">
                                <select class="form-control" [(ngModel)]="orderDeliveryField">
                                    <option *ngFor="let ds of orderDeliveryStatus" value="{{ds.id}}">{{ds.delivery_status}}</option>
                                </select>
                                <br>
                                <button class="btn btn-warning" (click)="updateOrderDeliveryField(o.order_id,'deliveryStatus',orderDeliveryField)">Update</button>                                                   
                        </div>
                    </div>
                    <p>Order type: {{o.order_type}}</p>
                </div>
            </div>
        </div>

        <div class="col-sm-9">
            <div class="card">
                <div class="card-header">
                    <h5>Transaction details 
                        <button *appUserRole="['superAdmin', 'admin' ]" class="btn btn-warning pull-right" (click)="openPostTransaction(postTransaction)">Add</button>
                        <!-- <button *ngIf="o.transaction_source!='Cashfree' && o.transaction_id==null && role=='admin'" class="btn btn-warning pull-right" (click)="openPostTransaction(postTransaction)">Add</button>
                        <button *ngIf="o.transaction_source!='Cashfree' && o.transaction_id!=null && role=='admin'" class="btn btn-warning pull-right" (click)="openPostTransaction(updateTransaction)">Edit</button> -->
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <th>Date</th>
                            <th>Transaction #</th>
                            <th>Source</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Message</th>
                            <th>Action</th>
                        </thead>
                        <tbody>
                            <tr *ngFor="let t of transactionDetails">
                                <td>{{t.createdAt | date:'dd MM yyyy HH:mm'}}</td>
                                <td>{{t.transaction_id}}</td>
                                <td>{{t.transaction_source}}</td>
                                <td>{{t.type}}</td>
                                <td>â‚¹{{t.order_amount}}</td>
                                <td>{{t.transaction_msg}}</td>
                                <td *appUserRole="['superAdmin', 'admin' ]"><button class="btn btn-warning" *ngIf="t.transaction_source=='Manual'" (click)="getTransactionById(t.id);openPostTransaction(updateTransaction)">Edit</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <p *ngIf="!paymentStatusActive">Payment status: {{o.paymentStatus}} <i class="fa fa-pencil" *ngIf="editStatus" (click)="paymentStatusActive=!paymentStatusActive"></i></p>
                    <div class="card" *ngIf="paymentStatusActive">
                        <div class="card-header">
                            <p>Payment status <span class="pull-right" (click)="paymentStatusActive=!paymentStatusActive">X</span></p>
                        </div>
                        <div class="card-body">
                                <select class="form-control" [(ngModel)]="orderField">
                                    <option *ngFor="let ps of paymentStatus" value="{{ps.id}}">{{ps.status_name}}</option>
                                </select>
                                <br>
                                <button class="btn btn-warning" (click)="updateOrderField(o.order_id,'paymentStatus',orderField)">Update</button>                                                   
                        </div>
                    </div>
                    <!-- <p>Transaction date: {{o.transactionDate | date:'dd MM yyyy HH:mm'}}</p>
                    <p>Transaction #: {{o.transaction_id}}</p>
                    <p>Transaction type: {{o.type}}</p>
                    <p>Transaction source : {{o.transaction_source}}</p>
                    <p>Transaction amount : â‚¹{{o.transactionAmount}}</p>
                    <p *ngIf="!paymentStatusActive">Payment status: {{o.paymentStatus}} <i class="fa fa-pencil" *ngIf="editStatus" (click)="paymentStatusActive=!paymentStatusActive"></i></p>
                    <div class="card" *ngIf="paymentStatusActive">
                        <div class="card-header">
                            <p>Payment status <span class="pull-right" (click)="paymentStatusActive=!paymentStatusActive">X</span></p>
                        </div>
                        <div class="card-body">
                                <select class="form-control" [(ngModel)]="orderField">
                                    <option *ngFor="let ps of paymentStatus" value="{{ps.id}}">{{ps.status_name}}</option>
                                </select>
                                <br>
                                <button class="btn btn-warning" (click)="updateOrderField(o.order_id,'paymentStatus',orderField)">Update</button>                                                   
                        </div>
                    </div> -->
                </div>
            </div>
        </div>

        <!-- <div class="col-sm-4">
            <div class="card">
                <div class="card-header">
                    <h5>Transaction message</h5>
                </div>
                <div class="card-body">
                    <p> {{o.transaction_msg}}</p>
                    
                    <textarea class="form-control" *ngIf="editStatus" rows="5" [(ngModel)]="o.transaction_msg"></textarea>
                    <button *ngIf="editStatus" class="btn btn-warning mt-2" (click)="updateTransactionField(o.transaction_id,'transaction_msg',o.transaction_msg)">Update</button>
                </div>
            </div>
        </div> -->

        
    </div>


    <div class="row my-products" *ngFor="let o of fullOrderDetails">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header" *appUserRole="['superAdmin', 'admin' ]">
                    <h5>Product details</h5>
                    <button class="btn btn-warning pull-right" *ngIf="!editStatus" (click)="editStatus=!editStatus">Edit order</button>
                    <button class="btn btn-warning pull-right" *ngIf="editStatus" (click)="editStatus=!editStatus">Cancel edit</button>
                </div>
                <div class="card-body">
        
                    
                    <table class="table table-striped table-bordered" *ngIf="o.orderType_id==1">
                        <thead>
                          <tr>
                            <th>Prod name</th>
                            <th>Tenure</th>
                            <th>Security Deposit</th>
                            <th>Rent/mo</th>
                            <th>Damage protection</th>
                            <th>Asset #</th>
                            <th>Delivery Date</th>
                            <th>Delivery status</th>
                          </tr>
                        </thead>
                        <tbody *ngFor="let p of productDetails">
                          <tr>
                            <td><p>{{p.prod_name}}</p>
                                <p>Product #: {{p.prod_id}}</p>
                            </td>
                            <td>{{p.tenure_period}}</td> 
                            <td>â‚¹{{p.security_deposit}}</td>
                            <td>â‚¹{{p.tenure_price+p.damage_protection}}</td>
                            <td *ngIf="p.damage_protection>0">Yes</td>
                            <td *ngIf="p.damage_protection<=0">No</td>
                            <td>{{p.asset_id}}</td> 
                            <td>{{p.startDate | date:'dd MM yyyy'}}</td>                            
                            <td>{{p.delivery_status}}
                            </td>                         
                          </tr> 
                          <tr *ngIf="editStatus && (o.orderType_id==1 || o.orderType_id==3)">
                            <td colspan="5"></td>
                            <td>
                                <form class="orders-form-popup" [formGroup]="assetAssign" (ngSubmit)="updateAssetId(p.order_item_id)">
                                    <label> Asset #:
                                        <!-- <select formControlName="assetId" class="form-control">
                                            <option [value]="p.asset_id">select</option>
                                            <option *ngFor="let a of assets" [value]="a.asset_no">{{a.asset_no}}</option>
                                        </select>  -->
                                        <input type="text" formControlName="assetId" class="form-control">
                                    </label>
                                    <div *ngIf="((deliveryStatus.value.deliveryStatus=='Shipped' && assetId=='') || (deliveryStatus.value.deliveryStatus=='Delivered' && assetId=='') || formError==true)" class="text text-danger">
                                        Asset # is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                </form>
                            </td>
                            <td>
                                <form [formGroup]="deliveryDateStatus" (ngSubmit)="updateDeliveryDate(p.order_item_id,p)">
                                    <label>Delivery date:<input class="form-control" type="date" formControlName="deliveryDate" [value]="currDate"> </label>
                                    <!-- <div *ngIf="((deliveryDateStatus.value.deliveryStatus=='Shipped' && deliveryDateStatus.value.deliveryDate=='') || (deliveryDateStatus.value.deliveryStatus=='Delivered' && deliveryDateStatus.value.assetId==''))" class="text text-danger">
                                        Delivery date is required.
                                    </div> -->
                                    <div *ngIf="p.deliveryDateAssigned==0 && (deliveryStatus.value.deliveryStatus=='Delivered' || deliveryStatus.value.deliveryStatus=='Shipped')" class="text text-danger">
                                      Delivery date is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                            <td>
                                <form [formGroup]="deliveryStatus" (ngSubmit)="updateProductDeliveryStatus(p.order_item_id,p)">                                
                                    <label> Delivery status:
                                      <select formControlName="deliveryStatus" class="form-control" required>   
                                          <option [value]="p.delivery_status">Select</option>                
                                          <!-- <option value="1">Awaiting KYC</option>
                                          <option value="2">Delivery awaited</option> -->
                                          <option value="3">Shipped</option>
                                          <option value="4">Delivered</option>
                                          <!-- <option value="5">Partially delivered</option> -->
                                          <option value="6">Return</option>
                                      </select> 
                                    </label><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                          </tr>                         
                        </tbody>
                    </table>

                    <table class="table table-striped table-bordered" *ngIf="o.orderType_id==2">
                        <thead>
                          <tr>
                            <th>Prod name</th>
                            <th>Asset #</th>
                            <th>DP</th>
                            <th>Delivery Date</th>
                            <th>Tenure</th>
                            <th>Start date</th>
                            <th>End date</th>
                            <th>Rent/mo</th>
                          </tr>
                        </thead>
                        <tbody *ngFor="let p of productDetails">
                          <tr>
                            <td><p>{{p.prod_name}}</p>
                                <p>Product #: {{p.prod_id}}</p>
                            </td>
                            <td>{{p.asset_id}}</td>                             
                            <td *ngIf="p.damage_protection>0">Yes</td>
                            <td *ngIf="p.damage_protection<=0">No</td>                            
                            <td>{{p.renewals_timline[0].actualStartDate}}</td> 
                            <td>{{p.tenure_period}}</td> 
                            <td>{{p.startDate | date:'dd/MM/yyyy'}}</td>   
                            <td>{{p.endDate | date:'dd/MM/yyyy'}}</td> 
                            <td>â‚¹{{p.tenure_price+p.damage_protection}}</td>                           
                          </tr> 
                          <tr *ngIf="editStatus && (o.orderType_id==1 || o.orderType_id==3)">
                            <td colspan="5"></td>
                            <td>
                                <form class="orders-form-popup" [formGroup]="assetAssign" (ngSubmit)="updateAssetId(p.order_item_id)">
                                    <label> Asset #:
                                        <!-- <select formControlName="assetId" class="form-control">
                                            <option [value]="p.asset_id">select</option>
                                            <option *ngFor="let a of assets" [value]="a.asset_no">{{a.asset_no}}</option>
                                        </select>  -->
                                        <input type="text" formControlName="assetId" class="form-control">
                                    </label>
                                    <div *ngIf="((deliveryStatus.value.deliveryStatus=='Shipped' && assetId=='') || (deliveryStatus.value.deliveryStatus=='Delivered' && assetId=='') || formError==true)" class="text text-danger">
                                        Asset # is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                </form>
                            </td>
                            <td>
                                <form [formGroup]="deliveryDateStatus" (ngSubmit)="updateDeliveryDate(p.order_item_id,p)">
                                    <label>Delivery date:<input class="form-control" type="date" formControlName="deliveryDate" [value]="currDate"> </label>
                                    <!-- <div *ngIf="((deliveryDateStatus.value.deliveryStatus=='Shipped' && deliveryDateStatus.value.deliveryDate=='') || (deliveryDateStatus.value.deliveryStatus=='Delivered' && deliveryDateStatus.value.assetId==''))" class="text text-danger">
                                        Delivery date is required.
                                    </div> -->
                                    <div *ngIf="p.deliveryDateAssigned==0 && (deliveryStatus.value.deliveryStatus=='Delivered' || deliveryStatus.value.deliveryStatus=='Shipped')" class="text text-danger">
                                      Delivery date is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                            <td>
                                <form [formGroup]="deliveryStatus" (ngSubmit)="updateProductDeliveryStatus(p.order_item_id,p)">                                
                                    <label> Delivery status:
                                      <select formControlName="deliveryStatus" class="form-control" required>   
                                          <option [value]="p.delivery_status">Select</option>                
                                          <!-- <option value="1">Awaiting KYC</option>
                                          <option value="2">Delivery awaited</option> -->
                                          <option value="3">Shipped</option>
                                          <option value="4">Delivered</option>
                                          <!-- <option value="5">Partially delivered</option> -->
                                          <option value="6">Return</option>
                                      </select> 
                                    </label><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                          </tr>                         
                        </tbody>
                    </table>

                    <h4 *ngIf="o.orderType_id==3">Returned products</h4>
                    <table class="table table-striped table-bordered" *ngIf="o.orderType_id==3">
                        <thead>
                          <tr>
                            <th>Prod name</th>
                            <th>Tenure</th>
                            <th>Security Deposit</th>
                            <th>Rent/mo</th>
                            <th>Damage protection</th>
                            <th>Asset #</th>
                            <th>Billing period</th>
                          </tr>
                        </thead>
                        <tbody *ngFor="let p of productDetails">
                          <tr>
                            <td><p>{{p.renewals_timline[0].returnedProduct.prod_name}}</p>
                                <p>Product #: {{p.renewals_timline[0].returnedProduct.prod_id}}</p>
                            </td>
                            <td>{{p.renewals_timline[0].returnedProduct.tenure}}</td> 
                            <td>â‚¹{{p.renewals_timline[0].returnedProduct.prod_price}}</td>
                            <td>â‚¹{{p.renewals_timline[0].returnedProduct.price+p.renewals_timline[0].returnedProduct.dp}}</td>
                            <td *ngIf="p.renewals_timline[0].returnedProduct.dp>0">Yes</td>
                            <td *ngIf="p.renewals_timline[0].returnedProduct.dp<=0">No</td>
                            <td>{{p.renewals_timline[0].returnedProduct.assetId}}</td> 
                            <td>{{p.renewals_timline[0].returnedProduct.billPeriod}}</td>
                          </tr>                        
                        </tbody>
                    </table>

                    <h4 *ngIf="o.orderType_id==3">Replaced products</h4>
                    <table class="table table-striped table-bordered" *ngIf="o.orderType_id==3">
                        <thead>
                          <tr>
                            <th>Prod name</th>
                            <th>Tenure</th>
                            <th>Security Deposit</th>
                            <th>Rent/mo</th>
                            <th>Damage protection</th>
                            <th>Asset #</th>
                            <th>Billing period</th>
                          </tr>
                        </thead>
                        <tbody *ngFor="let p of productDetails">
                          <tr>
                            <td><p>{{p.prod_name}}</p>
                                <p>Product #: {{p.prod_id}}</p>
                            </td>
                            <td>{{p.tenure_period}}</td> 
                            <td>â‚¹{{p.security_deposit}}</td>
                            <td>â‚¹{{p.tenure_price+p.damage_protection}}</td>
                            <td *ngIf="p.damage_protection>0">Yes</td>
                            <td *ngIf="p.damage_protection<=0">No</td>
                            <td>{{p.asset_id}}</td> 
                            <td>{{p.renewals_timline[0].billPeriod}}</td>                    
                          </tr> 
                          <tr *ngIf="editStatus && (o.orderType_id==1 || o.orderType_id==3)">
                            <td colspan="5"></td>
                            <td>
                                <form class="orders-form-popup" [formGroup]="assetAssign" (ngSubmit)="updateAssetId(p.order_item_id)">
                                    <label> Asset #:
                                        <!-- <select formControlName="assetId" class="form-control">
                                            <option [value]="p.asset_id">select</option>
                                            <option *ngFor="let a of assets" [value]="a.asset_no">{{a.asset_no}}</option>
                                        </select>  -->
                                        <input type="text" formControlName="assetId" class="form-control">
                                    </label>
                                    <div *ngIf="((deliveryStatus.value.deliveryStatus=='Shipped' && assetId=='') || (deliveryStatus.value.deliveryStatus=='Delivered' && assetId=='') || formError==true)" class="text text-danger">
                                        Asset # is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                </form>
                            </td>
                            <td>
                                <form [formGroup]="deliveryDateStatus" (ngSubmit)="updateDeliveryDate(p.order_item_id,p)">
                                    <label>Delivery date:<input class="form-control" type="date" formControlName="deliveryDate" [value]="currDate"> </label>
                                    <!-- <div *ngIf="((deliveryDateStatus.value.deliveryStatus=='Shipped' && deliveryDateStatus.value.deliveryDate=='') || (deliveryDateStatus.value.deliveryStatus=='Delivered' && deliveryDateStatus.value.assetId==''))" class="text text-danger">
                                        Delivery date is required.
                                    </div> -->
                                    <div *ngIf="p.deliveryDateAssigned==0 && (deliveryStatus.value.deliveryStatus=='Delivered' || deliveryStatus.value.deliveryStatus=='Shipped')" class="text text-danger">
                                      Delivery date is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                            <td>
                                <form [formGroup]="deliveryStatus" (ngSubmit)="updateProductDeliveryStatus(p.order_item_id,p)">                                
                                    <label> Delivery status:
                                      <select formControlName="deliveryStatus" class="form-control" required>   
                                          <option [value]="p.delivery_status">Select</option>                
                                          <!-- <option value="1">Awaiting KYC</option>
                                          <option value="2">Delivery awaited</option> -->
                                          <option value="3">Shipped</option>
                                          <option value="4">Delivered</option>
                                          <!-- <option value="5">Partially delivered</option> -->
                                          <option value="6">Return</option>
                                      </select> 
                                    </label><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                          </tr>                         
                        </tbody>
                    </table>

                    <table class="table table-striped table-bordered" *ngIf="o.orderType_id==4">
                        <thead>
                          <tr>
                            <th>Prod name</th>
                            <th>Start Date</th>
                            <th>Tenure</th>
                            <th>Security Deposit</th>
                            <th>Damage protection</th>
                            <th>Asset #</th>
                            <th>Delivery status</th>
                          </tr>
                        </thead>
                        <tbody *ngFor="let p of productDetails">
                          <tr>
                            <td><p>{{p.prod_name}}</p>
                                <p>Product #: {{p.prod_id}}</p>
                                <p>Total Period: {{p.renewals_timline[0].startDate}} - {{p.renewals_timline[0].returnDate}}</p>
                            </td>                            
                            <td>{{p.startDate | date:'dd MM yyyy'}}</td>   
                            <td>{{p.tenure_period}}</td> 
                            <td>â‚¹{{p.security_deposit}}</td>
                            <td *ngIf="p.damage_protection>0">Yes</td>
                            <td *ngIf="p.damage_protection<=0">No</td>
                            <td>{{p.asset_id}}</td>                          
                            <td>{{p.delivery_status}}
                            </td>                         
                          </tr> 
                          <tr *ngIf="editStatus && (o.orderType_id==1 || o.orderType_id==3)">
                            <td colspan="5"></td>
                            <td>
                                <form class="orders-form-popup" [formGroup]="assetAssign" (ngSubmit)="updateAssetId(p.order_item_id)">
                                    <label> Asset #:
                                        <!-- <select formControlName="assetId" class="form-control">
                                            <option [value]="p.asset_id">select</option>
                                            <option *ngFor="let a of assets" [value]="a.asset_no">{{a.asset_no}}</option>
                                        </select>  -->
                                        <input type="text" formControlName="assetId" class="form-control">
                                    </label>
                                    <div *ngIf="((deliveryStatus.value.deliveryStatus=='Shipped' && assetId=='') || (deliveryStatus.value.deliveryStatus=='Delivered' && assetId=='') || formError==true)" class="text text-danger">
                                        Asset # is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                </form>
                            </td>
                            <td *ngIf="o.orderType_id==1">
                                <form [formGroup]="deliveryDateStatus" (ngSubmit)="updateDeliveryDate(p.order_item_id, p)">
                                    <label>Delivery date:<input class="form-control" type="date" formControlName="deliveryDate" [value]="currDate"> </label>
                                    <!-- <div *ngIf="((deliveryDateStatus.value.deliveryStatus=='Shipped' && deliveryDateStatus.value.deliveryDate=='') || (deliveryDateStatus.value.deliveryStatus=='Delivered' && deliveryDateStatus.value.assetId==''))" class="text text-danger">
                                        Delivery date is required.
                                    </div> -->
                                    <div *ngIf="p.deliveryDateAssigned==0 && (deliveryStatus.value.deliveryStatus=='Delivered' || deliveryStatus.value.deliveryStatus=='Shipped')" class="text text-danger">
                                      Delivery date is required.
                                    </div><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                            <td *ngIf="o.orderType_id==1">
                                <form [formGroup]="deliveryStatus" (ngSubmit)="updateProductDeliveryStatus(p.order_item_id,p)">                                
                                    <label> Delivery status:
                                      <select formControlName="deliveryStatus" class="form-control" required>   
                                          <option [value]="p.delivery_status">Select</option>                
                                          <!-- <option value="1">Awaiting KYC</option>
                                          <option value="2">Delivery awaited</option> -->
                                          <option value="3">Shipped</option>
                                          <option value="4">Delivered</option>
                                          <!-- <option value="5">Partially delivered</option> -->
                                          <option value="6">Return</option>
                                      </select> 
                                    </label><br>
                                    <button class="btn btn-warning">Update</button>
                                  </form>
                            </td>
                          </tr>                         
                        </tbody>
                    </table>

        
                    <div *ngFor="let o of fullOrderDetails" class="pull-right text-right">
                        <div *ngIf="o.orderType_id!=3 && o.orderType_id!=4">
                            <h4 *ngIf="o.orderType_id==1">Sub total: <span>â‚¹{{o.subTotal+o.damageProtection}}</span></h4>
                            <h4 *ngIf="o.orderType_id==2">Sub total: <span>â‚¹{{subTotal+(o.damageProtection-0)}}</span></h4>
                            <h4 *ngIf="o.orderType_id==1">Delivery charges: <span>â‚¹{{o.deliveryCharges}}</span></h4>
                            <h4 *ngIf="o.orderType_id==1">Taxes: <span>â‚¹{{o.total-(o.subTotal+o.damageProtection+o.deliveryCharges)}}</span></h4>
                            <h4 *ngIf="o.orderType_id==2">Taxes: <span>â‚¹{{((subTotal+o.damageProtection)*(Taxes)/100)}}</span></h4>
                            <h4>Total: <span>â‚¹{{o.total}}</span></h4>
                            <h4 *ngIf="o.orderType_id==1">Total security deposit: <span>â‚¹{{o.totalSecurityDeposit}}</span></h4>
                            <h4>Grand Total: <span>â‚¹{{o.grandTotal}}</span></h4>
                        </div>
                        <div *ngIf="o.orderType_id==3">
                            <h4>Difference Rent: â‚¹{{o.orderItem[0].renewals_timline[0].p2Rent - o.orderItem[0].renewals_timline[0].returnedProduct.p1Rent}}</h4>
                            <h4 *ngIf="o.orderItem[0].renewals_timline[0].damageCharges>0">Damage / Delivery Charges: â‚¹{{o.orderItem[0].renewals_timline[0].damageCharges}}</h4>
                            <h4>GST: {{totalTaxAmount((o.orderItem[0].renewals_timline[0].p2Rent - o.orderItem[0].renewals_timline[0].returnedProduct.p1Rent)+o.orderItem[0].renewals_timline[0].damageCharges)}}</h4>
                            <h4>Sub total: â‚¹{{(o.orderItem[0].renewals_timline[0].p2Rent - o.orderItem[0].renewals_timline[0].returnedProduct.p1Rent)+o.orderItem[0].renewals_timline[0].damageCharges+totalTaxAmount((o.orderItem[0].renewals_timline[0].p2Rent - o.orderItem[0].renewals_timline[0].returnedProduct.p1Rent)+o.orderItem[0].renewals_timline[0].damageCharges)}}</h4>
                            <h4>Difference Deposit: {{o.orderItem[0].renewals_timline[0].securityDepositDiff}}</h4>
                            <h4>Total: â‚¹{{(o.orderItem[0].renewals_timline[0].p2Rent - o.orderItem[0].renewals_timline[0].returnedProduct.p1Rent)+o.orderItem[0].renewals_timline[0].damageCharges+totalTaxAmount((o.orderItem[0].renewals_timline[0].p2Rent - o.orderItem[0].renewals_timline[0].returnedProduct.p1Rent)+o.orderItem[0].renewals_timline[0].damageCharges)+o.orderItem[0].renewals_timline[0].securityDepositDiff}}</h4>
                        </div>
                        <div *ngIf="o.orderType_id==4">
                            <div>
                                <p>Damage / Delivery Charges / Extension Charges: â‚¹{{productDetails[0].damage_charges}}</p>
                                <div class="input-group mb-3 pull-right" *ngIf="editStatus">
                                    <input type="text" class="form-control" [(ngModel)]="productDetails[0].damage_charges">
                                    <div class="input-group-append">
                                      <button class="btn btn-warning" type="button" (click)="updateAnyOrderItemField(productDetails[0].order_item_id, 'damage_charges', productDetails[0].damage_charges);updateOrderField(o.order_id, 'subTotal', (productDetails[0].damage_charges-0)+(productDetails[0].earlyReturnCharges-0));updateOrderField(o.order_id, 'total', (productDetails[0].damage_charges-0)+(productDetails[0].earlyReturnCharges-0))">Update</button>
                                    </div>
                                </div>
                                <p>Early return charges:  â‚¹{{productDetails[0].earlyReturnCharges}}</p>
                                <div class="input-group mb-3 pull-right" *ngIf="editStatus">
                                    <input type="text" class="form-control" [(ngModel)]="productDetails[0].earlyReturnCharges">
                                    <div class="input-group-append">
                                      <button class="btn btn-warning" type="button" (click)="updateAnyOrderItemField(productDetails[0].order_item_id, 'earlyReturnCharges', productDetails[0].earlyReturnCharges);updateOrderField(o.order_id, 'subTotal', (productDetails[0].damage_charges-0)+(productDetails[0].earlyReturnCharges-0));updateOrderField(o.order_id, 'total', (productDetails[0].damage_charges-0)+(productDetails[0].earlyReturnCharges-0))">Update</button>
                                    </div>
                                </div>
                                <p *ngIf="o.grandTotal<=0">To be refunded: {{( this.totalSecurityDeposit)-((productDetails[0].damage_charges-0)+(productDetails[0].earlyReturnCharges-0))}}</p>
                                <p *ngIf="o.grandTotal>0">To be paid: {{o.grandTotal}}</p>
                            </div>
                        </div>
                    </div> 
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-8">
            <div class="card">
                <div class="card-header">
                    <h5>Comments</h5>
                </div>
                <div class="card-body">                    
                    <div class="card text-white bg-info mb-3" *ngFor="let n of notes">
                        <div class="card-body">
                            {{n.notes}}
                        </div>
                        <div class="card-footer text-white bg-info p-1 m-0">
                            Posted by {{n.firstName}} on {{n.created_at | date:'dd MM yyyy hh:mm'}}
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="card">
                <div class="card-header">
                    <h5>Add Comment</h5>
                </div>
                <div class="card-body">
                    
                    <textarea class="form-control" rows="5" [(ngModel)]="comment"></textarea>
                    <button class="btn btn-warning mt-2" (click)="postNotes()">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>


 <!--For pdf invoice-->
<div [id]="[fullOrderDetails[0].order_id]" hidden>
    <h1>Invoice</h1>

    <!-- <p>Name: {{o.fname}} {{o.lname}}</p>
    <p>Mobile: {{o.mobile}}</p>
    <p>Email: {{o.email}}</p>
    <p>Address: {{o.address}} {{o.city}} {{o.pincode}}</p>
    <p>Transaction: {{o.status}}</p> -->
    
  
    <table id="order-table" class="table table-striped">
        <tr>
            <th>Product</th>
            <th>Tenure</th>
            <th>Security deposit</th>
            <th>Rent/ mo</th>
            <!-- <th>Total</th> -->
        </tr>
        <tr *ngFor="let p of popupOrder">
            <td>
                <p>{{p.prod_name}}</p><br>
                <p>Bill period: {{p.renewals_timline[0].billPeriod}}</p><br>
                <p>Asset #: {{p.asset_id}}</p><br>
                <p *ngIf="p.renewals_timline[0].dp>0 ">Including damage protection</p>
            </td>
            <td>{{p.tenure_period}}</td>
            <td>{{p.security_deposit}}</td>
            <td>{{p.tenure_price+p.damage_protection}}</td>
            <!-- <td>{{p.security_deposit+p.tenure_price}}</td> -->
        </tr>
    </table>
    <!-- <table id="order-total">
        <tr>
            <td>Sub total</td>
            <td>â‚¹{{subTotal}}</td>
        </tr>
        <tr>
            <td>Security deposit</td>
            <td>â‚¹{{o.securitydeposit}}</td>
        </tr>
        <tr>
            <td>Security deposit</td>
            <td>â‚¹{{o.amount}}</td>
        </tr>
    </table> -->
    <hr>
    <!-- <p>Order Id: {{o.txnid}}</p>
    <p>Orders date: {{o.orderdate[0]}}</p>
    <p>Total: Rs-{{o.amount}}</p> -->
</div>


<ng-template #postTransaction let-c="close" let-d="dismiss">
    <div class="modal-header text-center">
      <h4 class="col-12 modal-title text-center" id="modal-basic-title">Manual transaction</h4>
      <button type="button" class="close" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
        <div class="row">  
            <div class="col-3"></div>        
            <div class="col-6">
                <form [formGroup]="addTransaction" (ngSubmit)="postTransactionData()">
                    
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Payment type</label>
                        <select class="form-control" formControlName="paymentMode">
                            <option>Select</option>
                            <option *ngFor="let pt of paymentTypes" value="{{pt.type}}">{{pt.type}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Transaction No.</label>
                        <input type="text" class="form-control" formControlName="transactionNo"><br>
                    </div>
                    <div class="form-group">
                        <label *ngIf="fullOrderDetails[0].orderType_id==4" for="validationTitle" class="col-form-label pt-0"><span>*</span> Payment status</label>
                        <!-- <select class="form-control" formControlName="paymentStatus" *ngIf="fullOrderDetails[0].orderType_id!=4">
                            <option>Select</option>
                            <option *ngFor="let ps of paymentStatuses" value="{{ps.id}}">{{ps.status_name}}</option>
                        </select> -->
                        <select class="form-control" formControlName="paymentStatus" *ngIf="fullOrderDetails[0].orderType_id==4">
                            <option>Select</option>
                            <option value="5">Refund initiated</option>
                            <option value="6">Refunded</option>
                            <option value="10">Refunded partial</option>
                        </select>
                    </div>
                    <div class="form-group" *ngIf="fullOrderDetails[0].orderType_id==4 || fullOrderDetails[0].orderType_id==1">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Transaction amount.</label>
                        <input type="text" class="form-control" formControlName="orderAmount"><br>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Message</label>
                        <textarea class="form-control" formControlName="txMsg"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Transaction date</label>
                        <input type="date" class="form-control" formControlName="tDate"><br>
                    </div>
                    <button class="btn btn-warning">Submit</button>
                </form>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #updateTransaction let-c="close" let-d="dismiss">
    <div class="modal-header text-center">
      <h4 class="col-12 modal-title text-center" id="modal-basic-title">Update transaction</h4>
      <button type="button" class="close" aria-label="Close" (click)="d()">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
        <div class="row">  
            <div class="col-3"></div>        
            <div class="col-6">
                <form [formGroup]="updateTransactionData" (ngSubmit)="updateTransactionManual()">
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Transaction No.</label>
                        <input type="text" class="form-control" formControlName="transactionNo"><br>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Payment type</label>
                        <select class="form-control" formControlName="paymentMode">
                            <option>Select</option>
                            <option *ngFor="let pt of paymentTypes" value="{{pt.type}}">{{pt.type}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Payment status</label>
                        <select class="form-control" formControlName="paymentStatus">
                            <option>Select</option>
                            <option *ngFor="let ps of paymentStatuses" value="{{ps.id}}">{{ps.status_name}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Transaction amount.</label>
                        <input type="text" class="form-control" formControlName="orderAmount"><br>
                    </div>
                    <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Message</label>
                        <textarea class="form-control" formControlName="txMsg"></textarea>
                    </div>
                    <!-- <div class="form-group">
                        <label for="validationTitle" class="col-form-label pt-0"><span>*</span> Transaction date</label>
                        <input type="date" class="form-control" formControlName="tDate"><br>
                    </div> -->
                    <button class="btn btn-warning" type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>
</ng-template>